<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Reporting - Aplikasi Pajak Daerah</title>
    <meta name="description" content="Advanced reporting dengan analisis mendalam dan export capabilities">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .advanced-report-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .report-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .report-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-primary, .btn-secondary, .btn-success {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .report-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #e9ecef;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .chart-card h3 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #28a745;
        }

        .metric-change.negative {
            color: #dc3545;
        }

        .export-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .export-section h3 {
            margin: 0 0 20px 0;
            color: #495057;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .comparison-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .comparison-period {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .comparison-period.current {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .comparison-period.previous {
            border-color: #6c757d;
            background: rgba(108, 117, 125, 0.05);
        }

        .period-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .period-metrics {
            display: grid;
            gap: 10px;
        }

        .period-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .period-metric:last-child {
            border-bottom: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .date-range-display {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .date-range-display strong {
            color: #495057;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                flex-direction: column;
            }

            .filter-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-primary, .btn-secondary, .btn-success {
                justify-content: center;
            }
        }
    </style>
</head>
<body id="page-advanced-report">

    <div class="instansi-header">
        <img src="images/logo.png" alt="Logo" class="instansi-logo">
        <div class="instansi-text">
            <div class="instansi-title">APLIKASI SISTEM INFORMASI PENDAPATAN DAERAH</div>
            <div class="instansi-sub">BIDANG PENDAPATAN DAERAH</div>
            <div class="instansi-sub2">BADAN PENDAPATAN PENGELOLAAN KEUANGAN DAN ASET DAERAH KABUPATEN MAMBERAMO RAYA</div>
        </div>
    </div>

    <div class="sidebar-menu">
        <nav>
            <a href="index.html">Dasbor</a>
            <a href="tambah-data.html">Tambah Data WP</a>
            <a href="lihat-data.html">Lihat Data WP</a>
            <a href="tambah-ketetapan.html">Buat Ketetapan</a>
            <a href="daftar-ketetapan.html">Daftar Ketetapan</a>
            <a href="setoran-pajak.html">Setoran Pajak</a>
            <a href="daftar-pembayaran.html">Daftar Pembayaran</a>
            <a href="daftar-fiskal.html">Daftar Fiskal</a>
            <a href="review-wajib-pajak.html">Review Data WP</a>
            <a href="report.html">Laporan</a>
            <a href="advanced-report.html" class="active">🚀 Advanced Reporting</a>
            <a href="target.html">Target Pajak & Retribusi</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="advanced-report-container">
            <!-- Header -->
            <div class="report-header">
                <h1>🚀 Advanced Reporting</h1>
                <p>Analisis mendalam dengan insights cerdas dan export capabilities</p>
            </div>

            <!-- Filters -->
            <div class="filter-section">
                <h3 style="margin-bottom: 20px; color: #495057;">🎯 Filter & Periode</h3>

                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="reportType">Tipe Laporan</label>
                        <select id="reportType">
                            <option value="summary">Ringkasan Pendapatan</option>
                            <option value="comparison">Perbandingan Periode</option>
                            <option value="performance">Analisis Performa</option>
                            <option value="trends">Trend Analysis</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="dateRange">Rentang Tanggal</label>
                        <select id="dateRange">
                            <option value="today">Hari Ini</option>
                            <option value="yesterday">Kemarin</option>
                            <option value="thisWeek">Minggu Ini</option>
                            <option value="lastWeek">Minggu Lalu</option>
                            <option value="thisMonth">Bulan Ini</option>
                            <option value="lastMonth">Bulan Lalu</option>
                            <option value="thisQuarter">Kuartal Ini</option>
                            <option value="lastQuarter">Kuartal Lalu</option>
                            <option value="thisYear">Tahun Ini</option>
                            <option value="lastYear">Tahun Lalu</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <div class="filter-group" id="startDateGroup" style="display: none;">
                        <label for="startDate">Tanggal Mulai</label>
                        <input type="date" id="startDate">
                    </div>

                    <div class="filter-group" id="endDateGroup" style="display: none;">
                        <label for="endDate">Tanggal Akhir</label>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn-primary" onclick="generateReport()">
                        <span>📊</span> Generate Report
                    </button>
                    <button class="btn-secondary" onclick="resetFilters()">
                        <span>🔄</span> Reset Filter
                    </button>
                    <div id="dateRangeDisplay" class="date-range-display" style="display: none;">
                        <strong>Periode:</strong> <span id="currentPeriod">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="export-section">
                <h3>📄 Export & Print</h3>
                <div class="export-buttons">
                    <button class="btn-success" onclick="exportToPDF()">
                        <span>📕</span> Export PDF
                    </button>
                    <button class="btn-success" onclick="exportToExcel()">
                        <span>📊</span> Export Excel
                    </button>
                    <button class="btn-secondary" onclick="exportToCSV()">
                        <span>📋</span> Export CSV
                    </button>
                    <button class="btn-secondary" onclick="printReport()">
                        <span>🖨️</span> Print Report
                    </button>
                </div>
            </div>

            <!-- Report Tabs -->
            <div class="report-tabs">
                <button class="tab-btn active" onclick="showTab('overview')">📊 Overview</button>
                <button class="tab-btn" onclick="showTab('comparison')">📈 Comparison</button>
                <button class="tab-btn" onclick="showTab('trends')">📉 Trends</button>
                <button class="tab-btn" onclick="showTab('insights')">💡 Insights</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <h3 style="margin-bottom: 20px; color: #495057;">📊 Dashboard Overview</h3>

                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalRevenue">Loading...</div>
                        <div class="metric-label">Total Pendapatan</div>
                        <div class="metric-change positive" id="revenueChange">+12.5%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalTaxpayers">Loading...</div>
                        <div class="metric-label">Jumlah Wajib Pajak</div>
                        <div class="metric-change positive" id="taxpayersChange">+8.2%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="complianceRate">Loading...</div>
                        <div class="metric-label">Tingkat Kepatuhan</div>
                        <div class="metric-change positive" id="complianceChange">+5.1%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgPayment">Loading...</div>
                        <div class="metric-label">Rata-rata Pembayaran</div>
                        <div class="metric-change negative" id="avgPaymentChange">-2.3%</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Pendapatan per Bulan</h3>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Distribusi per Jenis Pajak</h3>
                        <div class="chart-container">
                            <canvas id="taxTypeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Kepatuhan Pembayaran</h3>
                        <div class="chart-container">
                            <canvas id="complianceChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Top Performing Kecamatan</h3>
                        <div class="chart-container">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Tab -->
            <div id="comparison-tab" class="tab-content">
                <h3 style="margin-bottom: 20px; color: #495057;">📈 Periode Comparison</h3>

                <div class="comparison-section">
                    <div class="comparison-grid">
                        <div class="comparison-period current">
                            <div class="period-title">📅 Periode Saat Ini</div>
                            <div class="period-metrics" id="currentPeriodMetrics">
                                <div class="period-metric">
                                    <span>Total Pendapatan</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Jumlah WP</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Tingkat Kepatuhan</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Rata-rata per WP</span>
                                    <span>Loading...</span>
                                </div>
                            </div>
                        </div>

                        <div class="comparison-period previous">
                            <div class="period-title">📅 Periode Sebelumnya</div>
                            <div class="period-metrics" id="previousPeriodMetrics">
                                <div class="period-metric">
                                    <span>Total Pendapatan</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Jumlah WP</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Tingkat Kepatuhan</span>
                                    <span>Loading...</span>
                                </div>
                                <div class="period-metric">
                                    <span>Rata-rata per WP</span>
                                    <span>Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Perbandingan Growth Rate</h3>
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trends-tab" class="tab-content">
                <h3 style="margin-bottom: 20px; color: #495057;">📉 Trend Analysis</h3>

                <div class="chart-card">
                    <h3>Trend Pendapatan 12 Bulan Terakhir</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Seasonal Pattern</h3>
                        <div class="chart-container">
                            <canvas id="seasonalChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Growth Velocity</h3>
                        <div class="chart-container">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights-tab" class="tab-content">
                <h3 style="margin-bottom: 20px; color: #495057;">💡 AI-Powered Insights</h3>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="predictedRevenue">Loading...</div>
                        <div class="metric-label">Prediksi Pendapatan Bulan Depan</div>
                        <div class="metric-change" id="predictionConfidence">Confidence: 85%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="riskLevel">Loading...</div>
                        <div class="metric-label">Tingkat Risiko</div>
                        <div class="metric-change" id="riskStatus">Status: Low Risk</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="efficiencyScore">Loading...</div>
                        <div class="metric-label">Skor Efisiensi</div>
                        <div class="metric-change" id="efficiencyTrend">+2.1%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="growthPotential">Loading...</div>
                        <div class="metric-label">Potensi Pertumbuhan</div>
                        <div class="metric-change" id="growthIndicator">High Potential</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Predictive Analytics</h3>
                    <div class="chart-container">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Generating Report...</h3>
            <p>Please wait while we analyze your data</p>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Advanced Reporting JavaScript
        let reportData = null;
        let currentFilters = {
            reportType: 'summary',
            dateRange: 'thisMonth',
            startDate: null,
            endDate: null
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdvancedReporting();
            setupEventListeners();
            generateReport();
        });

        function initializeAdvancedReporting() {
            console.log('🚀 Initializing Advanced Reporting...');

            // Set default dates
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('startDate').value = formatDateForInput(firstDayOfMonth);
            document.getElementById('endDate').value = formatDateForInput(lastDayOfMonth);

            updateDateRangeDisplay();
        }

        function setupEventListeners() {
            // Date range change
            document.getElementById('dateRange').addEventListener('change', function() {
                const customRange = this.value === 'custom';
                document.getElementById('startDateGroup').style.display = customRange ? 'block' : 'none';
                document.getElementById('endDateGroup').style.display = customRange ? 'block' : 'none';
                updateDateRangeDisplay();
            });

            // Custom date inputs
            document.getElementById('startDate').addEventListener('change', updateDateRangeDisplay);
            document.getElementById('endDate').addEventListener('change', updateDateRangeDisplay);
        }

        function updateDateRangeDisplay() {
            const dateRange = document.getElementById('dateRange').value;
            const display = document.getElementById('dateRangeDisplay');
            const period = document.getElementById('currentPeriod');

            let periodText = '';

            if (dateRange === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                periodText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            } else {
                const ranges = {
                    today: 'Hari Ini',
                    yesterday: 'Kemarin',
                    thisWeek: 'Minggu Ini',
                    lastWeek: 'Minggu Lalu',
                    thisMonth: 'Bulan Ini',
                    lastMonth: 'Bulan Lalu',
                    thisQuarter: 'Kuartal Ini',
                    lastQuarter: 'Kuartal Lalu',
                    thisYear: 'Tahun Ini',
                    lastYear: 'Tahun Lalu'
                };
                periodText = ranges[dateRange] || 'Unknown';
            }

            period.textContent = periodText;
            display.style.display = 'inline-block';
        }

        async function generateReport() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                console.log('📊 Generating advanced report...');

                // Get current filters
                currentFilters = {
                    reportType: document.getElementById('reportType').value,
                    dateRange: document.getElementById('dateRange').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value
                };

                // Fetch data from API
                const response = await fetch('/.netlify/functions/api');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('📡 API Response:', data);

                if (data.status === 'success' || data.status === 'sukses') {
                    reportData = data;
                    console.log('✅ Report data loaded successfully:', data);

                    // Update all visualizations
                    updateOverviewTab(data);
                    updateComparisonTab(data);
                    updateTrendsTab(data);
                    updateInsightsTab(data);

                    // Show success message
                    showNotification('Report generated successfully!', 'success');

                } else {
                    console.error('❌ API returned error status:', data);
                    throw new Error(data.message || data.error || 'Failed to load report data');
                }

            } catch (error) {
                console.error('❌ Error generating report:', error);
                alert('Error generating report: ' + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function updateOverviewTab(data) {
            try {
                // Ensure data structure exists
                if (!data) {
                    console.warn('No data provided to updateOverviewTab');
                    return;
                }

                // Update metrics with safe fallbacks
                const pembayaran = Array.isArray(data.pembayaran) ? data.pembayaran : [];
                const wajibPajak = Array.isArray(data.wajibPajak) ? data.wajibPajak : [];

                const totalRevenue = calculateTotalRevenue(pembayaran);
                const totalTaxpayers = wajibPajak.length;
                const complianceRate = calculateComplianceRate(data);
                const avgPayment = pembayaran.length > 0 ? totalRevenue / pembayaran.length : 0;

                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('totalTaxpayers').textContent = totalTaxpayers;
                document.getElementById('complianceRate').textContent = complianceRate + '%';
                document.getElementById('avgPayment').textContent = formatCurrency(avgPayment);

                // Create charts with error handling
                try {
                    createRevenueChart(data);
                } catch (error) {
                    console.error('Error creating revenue chart:', error);
                }

                try {
                    createTaxTypeChart(data);
                } catch (error) {
                    console.error('Error creating tax type chart:', error);
                }

                try {
                    createComplianceChart(data);
                } catch (error) {
                    console.error('Error creating compliance chart:', error);
                }

                try {
                    createRegionChart(data);
                } catch (error) {
                    console.error('Error creating region chart:', error);
                }

                console.log('✅ Overview tab updated successfully');
            } catch (error) {
                console.error('❌ Error updating overview tab:', error);
            }
        }

        function updateComparisonTab(data) {
            try {
                const currentMetrics = document.getElementById('currentPeriodMetrics');
                const pembayaran = Array.isArray(data.pembayaran) ? data.pembayaran : [];
                const wajibPajak = Array.isArray(data.wajibPajak) ? data.wajibPajak : [];

                const totalRevenue = calculateTotalRevenue(pembayaran);
                const complianceRate = calculateComplianceRate(data);
                const avgPerWP = wajibPajak.length > 0 ? totalRevenue / wajibPajak.length : 0;

                currentMetrics.innerHTML = `
                    <div class="period-metric">
                        <span>Total Pendapatan</span>
                        <span>${formatCurrency(totalRevenue)}</span>
                    </div>
                    <div class="period-metric">
                        <span>Jumlah WP</span>
                        <span>${wajibPajak.length}</span>
                    </div>
                    <div class="period-metric">
                        <span>Tingkat Kepatuhan</span>
                        <span>${complianceRate}%</span>
                    </div>
                    <div class="period-metric">
                        <span>Rata-rata per WP</span>
                        <span>${formatCurrency(avgPerWP)}</span>
                    </div>
                `;

                // Create comparison chart with error handling
                try {
                    createComparisonChart(data);
                } catch (error) {
                    console.error('Error creating comparison chart:', error);
                }

                console.log('✅ Comparison tab updated successfully');
            } catch (error) {
                console.error('❌ Error updating comparison tab:', error);
            }
        }

        function updateTrendsTab(data) {
            try {
                // Create charts with error handling
                try {
                    createTrendChart(data);
                } catch (error) {
                    console.error('Error creating trend chart:', error);
                }

                try {
                    createSeasonalChart(data);
                } catch (error) {
                    console.error('Error creating seasonal chart:', error);
                }

                try {
                    createGrowthChart(data);
                } catch (error) {
                    console.error('Error creating growth chart:', error);
                }

                console.log('✅ Trends tab updated successfully');
            } catch (error) {
                console.error('❌ Error updating trends tab:', error);
            }
        }

        function updateInsightsTab(data) {
            try {
                // Calculate predictive analytics with safe fallbacks
                const pembayaran = Array.isArray(data.pembayaran) ? data.pembayaran : [];
                const totalRevenue = calculateTotalRevenue(pembayaran);
                const predictedRevenue = totalRevenue * 1.15; // 15% growth prediction

                document.getElementById('predictedRevenue').textContent = formatCurrency(predictedRevenue);
                document.getElementById('riskLevel').textContent = 'Low';
                document.getElementById('efficiencyScore').textContent = '94%';
                document.getElementById('growthPotential').textContent = 'High';

                // Create prediction chart with error handling
                try {
                    createPredictionChart(data);
                } catch (error) {
                    console.error('Error creating prediction chart:', error);
                }

                console.log('✅ Insights tab updated successfully');
            } catch (error) {
                console.error('❌ Error updating insights tab:', error);
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function resetFilters() {
            document.getElementById('reportType').value = 'summary';
            document.getElementById('dateRange').value = 'thisMonth';

            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('startDate').value = formatDateForInput(firstDayOfMonth);
            document.getElementById('endDate').value = formatDateForInput(lastDayOfMonth);

            document.getElementById('startDateGroup').style.display = 'none';
            document.getElementById('endDateGroup').style.display = 'none';

            updateDateRangeDisplay();
            generateReport();
        }

        // Chart creation functions
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const monthlyData = aggregateByMonth(data.pembayaran || []);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Pendapatan Bulanan',
                        data: monthlyData.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTaxTypeChart(data) {
            const ctx = document.getElementById('taxTypeChart').getContext('2d');
            const taxTypeData = aggregateByTaxType(data);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: taxTypeData.labels,
                    datasets: [{
                        data: taxTypeData.values,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createComplianceChart(data) {
            const ctx = document.getElementById('complianceChart').getContext('2d');
            const complianceData = calculateComplianceData(data);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lunas', 'Belum Lunas', 'Overdue'],
                    datasets: [{
                        label: 'Jumlah Ketetapan',
                        data: complianceData,
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createRegionChart(data) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            const regionData = aggregateByRegion(data);

            new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: regionData.labels,
                    datasets: [{
                        label: 'Pendapatan per Kecamatan',
                        data: regionData.values,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function createComparisonChart(data) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pendapatan', 'Jumlah WP', 'Kepatuhan'],
                    datasets: [
                        {
                            label: 'Periode Saat Ini',
                            data: [100, 80, 85],
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Periode Sebelumnya',
                            data: [90, 75, 80],
                            backgroundColor: '#6c757d'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            // Mock 12-month trend data
            const trendData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                values: [80, 85, 90, 95, 100, 105, 110, 115, 120, 125, 130, 135]
            };

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Trend Pendapatan',
                        data: trendData.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createSeasonalChart(data) {
            const ctx = document.getElementById('seasonalChart').getContext('2d');

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [{
                        label: 'Seasonal Pattern',
                        data: [70, 75, 85, 90, 95, 100, 105, 110, 115, 120, 125, 130],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createGrowthChart(data) {
            const ctx = document.getElementById('growthChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                    datasets: [{
                        label: 'Growth Rate (%)',
                        data: [5, 8, 12, 15, 18, 22],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createPredictionChart(data) {
            const ctx = document.getElementById('predictionChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Current', 'Month 1', 'Month 2', 'Month 3'],
                    datasets: [
                        {
                            label: 'Actual Data',
                            data: [100, null, null, null],
                            borderColor: '#667eea',
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Prediction',
                            data: [null, 115, 130, 145],
                            borderColor: '#28a745',
                            backgroundColor: '#28a745',
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        // Utility functions
        function calculateTotalRevenue(pembayaran) {
            return pembayaran
                .filter(p => p.StatusPembayaran === 'Sukses')
                .reduce((sum, p) => sum + (parseFloat(p.JumlahBayar) || 0), 0);
        }

        function calculateComplianceRate(data) {
            const ketetapan = data.ketetapan || [];
            const pembayaran = data.pembayaran || [];

            if (ketetapan.length === 0) return 0;

            const paidKetetapan = new Set(
                pembayaran
                    .filter(p => p.StatusPembayaran === 'Sukses')
                    .map(p => p.ID_Ketetapan)
            );

            return Math.round((paidKetetapan.size / ketetapan.length) * 100);
        }

        function aggregateByMonth(pembayaran) {
            const monthlyData = {};
            const currentYear = new Date().getFullYear();

            pembayaran.forEach(p => {
                if (p.StatusPembayaran === 'Sukses' && p.TanggalBayar) {
                    const date = new Date(p.TanggalBayar);
                    if (date.getFullYear() === currentYear) {
                        const month = date.toLocaleDateString('id-ID', { month: 'short' });
                        monthlyData[month] = (monthlyData[month] || 0) + parseFloat(p.JumlahBayar || 0);
                    }
                }
            });

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            return {
                labels: months,
                values: months.map(month => monthlyData[month] || 0)
            };
        }

        function aggregateByTaxType(data) {
            const taxTypeData = {};
            const pembayaran = data.pembayaran || [];
            const ketetapan = data.ketetapan || [];
            const masterPajak = data.masterPajak || [];

            pembayaran.forEach(p => {
                if (p.StatusPembayaran === 'Sukses') {
                    const ket = ketetapan.find(k => k.ID_Ketetapan === p.ID_Ketetapan);
                    if (ket) {
                        const master = masterPajak.find(m => m.KodeLayanan === ket.KodeLayanan);
                        const taxType = master ? master.NamaLayanan : 'Unknown';
                        taxTypeData[taxType] = (taxTypeData[taxType] || 0) + parseFloat(p.JumlahBayar || 0);
                    }
                }
            });

            return {
                labels: Object.keys(taxTypeData),
                values: Object.values(taxTypeData)
            };
        }

        function calculateComplianceData(data) {
            const ketetapan = data.ketetapan || [];
            const pembayaran = data.pembayaran || [];

            const paidKetetapan = new Set(
                pembayaran
                    .filter(p => p.StatusPembayaran === 'Sukses')
                    .map(p => p.ID_Ketetapan)
            );

            const lunas = paidKetetapan.size;
            const belumLunas = ketetapan.length - lunas;
            const overdue = ketetapan.filter(k => {
                if (!k.TanggalKetetapan) return false;
                const dueDate = new Date(k.TanggalKetetapan);
                dueDate.setMonth(dueDate.getMonth() + 1); // 1 month grace period
                return new Date() > dueDate && !paidKetetapan.has(k.ID_Ketetapan);
            }).length;

            return [lunas, belumLunas - overdue, overdue];
        }

        function aggregateByRegion(data) {
            const regionData = {};
            const pembayaran = data.pembayaran || [];
            const wajibPajak = data.wajibPajak || [];

            pembayaran.forEach(p => {
                if (p.StatusPembayaran === 'Sukses') {
                    const wp = wajibPajak.find(w => w.NPWPD === p.NPWPD);
                    if (wp) {
                        const region = wp.Kecamatan || 'Unknown';
                        regionData[region] = (regionData[region] || 0) + parseFloat(p.JumlahBayar || 0);
                    }
                }
            });

            return {
                labels: Object.keys(regionData),
                values: Object.values(regionData)
            };
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Export functions
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add title
            doc.setFontSize(20);
            doc.text('Advanced Report - Sistem Informasi Pendapatan Daerah', 20, 30);

            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString('id-ID')}`, 20, 50);

            // Add summary data
            if (reportData) {
                doc.text(`Total Revenue: ${formatCurrency(calculateTotalRevenue(reportData.pembayaran || []))}`, 20, 70);
                doc.text(`Total Taxpayers: ${reportData.wajibPajak?.length || 0}`, 20, 85);
                doc.text(`Compliance Rate: ${calculateComplianceRate(reportData)}%`, 20, 100);
            }

            doc.save('advanced-report.pdf');
        }

        async function exportToExcel() {
            const wb = XLSX.utils.book_new();

            if (reportData) {
                // Summary sheet
                const summaryData = [
                    ['Metric', 'Value'],
                    ['Total Revenue', calculateTotalRevenue(reportData.pembayaran || [])],
                    ['Total Taxpayers', reportData.wajibPajak?.length || 0],
                    ['Compliance Rate', `${calculateComplianceRate(reportData)}%`],
                    ['Total Ketetapan', reportData.ketetapan?.length || 0],
                    ['Total Pembayaran', reportData.pembayaran?.length || 0]
                ];
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

                // Taxpayers sheet
                if (reportData.wajibPajak) {
                    const wsTaxpayers = XLSX.utils.json_to_sheet(reportData.wajibPajak);
                    XLSX.utils.book_append_sheet(wb, wsTaxpayers, 'Taxpayers');
                }

                // Payments sheet
                if (reportData.pembayaran) {
                    const wsPayments = XLSX.utils.json_to_sheet(reportData.pembayaran);
                    XLSX.utils.book_append_sheet(wb, wsPayments, 'Payments');
                }

                // Ketetapan sheet
                if (reportData.ketetapan) {
                    const wsKetetapan = XLSX.utils.json_to_sheet(reportData.ketetapan);
                    XLSX.utils.book_append_sheet(wb, wsKetetapan, 'Ketetapan');
                }
            }

            XLSX.writeFile(wb, 'advanced-report.xlsx');
        }

        function exportToCSV() {
            if (!reportData) return;

            let csvContent = 'data:text/csv;charset=utf-8,';

            // Summary
            csvContent += 'Summary\n';
            csvContent += `Total Revenue,${calculateTotalRevenue(reportData.pembayaran || [])}\n`;
            csvContent += `Total Taxpayers,${reportData.wajibPajak?.length || 0}\n`;
            csvContent += `Compliance Rate,${calculateComplianceRate(reportData)}%\n\n`;

            // Taxpayers
            if (reportData.wajibPajak && reportData.wajibPajak.length > 0) {
                csvContent += 'Taxpayers\n';
                const headers = Object.keys(reportData.wajibPajak[0]).join(',');
                csvContent += headers + '\n';
                reportData.wajibPajak.forEach(row => {
                    const values = Object.values(row).join(',');
                    csvContent += values + '\n';
                });
                csvContent += '\n';
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'advanced-report.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printReport() {
            window.print();
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;

            // Set background color based on type
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            notification.style.backgroundColor = colors[type] || colors.info;

            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="
                    margin-left: 15px;
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    opacity: 0.8;
                ">×</button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Add notification styles
        const notificationStyles = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;

        // Inject styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = notificationStyles;
        document.head.appendChild(styleSheet);

        // Initialize with sample data if no real data
        if (!reportData) {
            console.log('🔄 Initializing with sample data...');
            // This will be replaced with real data when generateReport() is called
        }

        console.log('🚀 Advanced Reporting initialized successfully!');
    </script>

    <div class="watermark-footer">MADE BY REYNOLDS - Advanced Reporting System</div>
</body>
</html>